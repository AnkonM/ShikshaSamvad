<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ShikshaSamvad</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-slate-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="landing-page.html" class="flex-shrink-0 flex items-center gap-2">
                        <svg class="h-8 w-auto" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M50 8.33331C26.9167 8.33331 8.33337 26.9166 8.33337 50C8.33337 73.0833 26.9167 91.6666 50 91.6666C73.0834 91.6666 91.6667 73.0833 91.6667 50C91.6667 26.9166 73.0834 8.33331 50 8.33331Z" fill="url(#paint0_linear_1_2)" fill-opacity="0.1"/>
                            <path d="M54.1667 37.5V25H45.8334V37.5H54.1667ZM63.5417 42.1875L72.2917 33.4375L66.5625 27.7083L57.8125 36.4583L63.5417 42.1875ZM36.4584 42.1875L42.1875 36.4583L33.4375 27.7083L27.7084 33.4375L36.4584 42.1875ZM50 60.4167C46.7292 60.4167 43.75 58.7396 41.6667 56.25H58.3334C56.25 58.7396 53.2709 60.4167 50 60.4167ZM48.6979 52.0833C49.1146 52.1875 49.5313 52.2396 50 52.2396C50.4688 52.2396 50.8854 52.1875 51.3021 52.0833C52.1354 51.9271 52.8646 51.5625 53.4375 51.0417C54.0104 50.5208 54.375 49.7917 54.375 48.9583C54.375 47.7604 53.4375 46.8229 52.2396 46.8229C51.0417 46.8229 50.1042 47.7604 50.1042 48.9583C50.1042 49.0625 50.1042 49.1667 50.1563 49.2708L42.0834 57.3437C44.4792 60.8333 48.4896 63.3333 53.125 64.2187V70.8333H57.2917V75H42.7084V70.8333H46.875V64.2187C40.6771 63.125 35.4167 57.8646 35.4167 51.0417C35.4167 43.125 41.875 36.6667 49.7917 36.6667C57.7084 36.6667 64.1667 43.125 64.1667 51.0417C64.1667 54.4792 62.9167 57.6562 60.9896 60.0521L55.9375 55C56.0938 54.3229 56.25 53.6458 56.25 52.9167C56.25 51.1979 55.5729 49.6875 54.4792 48.5937C53.3854 47.5 51.875 46.8229 50.1563 46.8229C48.4375 46.8229 46.9271 47.5 45.8334 48.5937C44.7396 49.6875 44.0625 51.1979 44.0625 52.9167C44.0625 53.6458 44.2188 54.3229 44.375 55L48.6979 52.0833Z" fill="url(#paint1_linear_1_2)"/>
                            <defs>
                                <linearGradient id="paint0_linear_1_2" x1="50" y1="8.33331" x2="50" y2="91.6666" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#22c55e"/>
                                <stop offset="1" stop-color="#15803d"/>
                                </linearGradient>
                                <linearGradient id="paint1_linear_1_2" x1="50" y1="25" x2="50" y2="75" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#f97316"/>
                                <stop offset="1" stop-color="#ea580c"/>
                                </linearGradient>
                            </defs>
                        </svg>
                        <span class="text-xl font-bold text-slate-900">ShikshaSamvad</span>
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="user-welcome" class="text-sm text-slate-600">Welcome, <span id="user-name"></span></span>
                    <button id="logout-btn" class="text-sm text-slate-500 hover:text-slate-700">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Page Header -->
        <div class="px-4 py-6 sm:px-0">
            <div class="border-4 border-dashed border-slate-200 rounded-lg p-8">
                <h1 class="text-3xl font-bold text-slate-900 mb-4">Dashboard</h1>
                <p class="text-slate-600 mb-6">Welcome to your ShikshaSamvad dashboard. Here you can access all the features based on your role.</p>
                
                <!-- Role-based content -->
                <div id="role-content" class="space-y-6">
                    <!-- Student Content -->
                    <div id="student-content" class="hidden">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h2 class="text-lg font-semibold text-blue-900 mb-2">Student Dashboard</h2>
                            <p class="text-blue-700">View your wellness data, chat with the AI counselor, and track your progress.</p>
                        </div>
                        
                        <!-- Chat Section -->
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold text-slate-900 mb-4">AI Counselor Chat</h3>
                            <div id="chat-container" class="border border-slate-200 rounded-lg p-4 h-64 overflow-y-auto mb-4">
                                <div class="text-slate-500 text-center">Start a conversation with our AI counselor...</div>
                            </div>
                            <div class="flex space-x-2">
                                <input id="chat-input" type="text" placeholder="Type your message..." class="flex-1 border border-slate-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                                <button id="send-chat" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Send</button>
                            </div>
                        </div>
                    </div>

                    <!-- Counselor Content -->
                    <div id="counselor-content" class="hidden">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h2 class="text-lg font-semibold text-green-900 mb-2">Counselor Dashboard</h2>
                            <p class="text-green-700">Monitor student wellness, view risk assessments, and manage interventions.</p>
                        </div>
                        
                        <!-- Risk Assessment Table -->
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold text-slate-900 mb-4">Student Risk Assessments</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-slate-200">
                                    <thead class="bg-slate-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Student ID</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Course</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Risk Level</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Confidence</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="risk-table-body" class="bg-white divide-y divide-slate-200">
                                        <tr>
                                            <td colspan="5" class="px-6 py-4 text-center text-slate-500">Loading risk data...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Faculty Content -->
                    <div id="faculty-content" class="hidden">
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                            <h2 class="text-lg font-semibold text-orange-900 mb-2">Faculty Dashboard</h2>
                            <p class="text-orange-700">View class reports, student alerts, and academic performance insights.</p>
                        </div>
                        
                        <!-- Class Performance Chart -->
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold text-slate-900 mb-4">Class Performance Overview</h3>
                            <canvas id="performance-chart" width="400" height="200"></canvas>
                        </div>
                    </div>

                    <!-- Admin Content -->
                    <div id="admin-content" class="hidden">
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                            <h2 class="text-lg font-semibold text-purple-900 mb-2">Admin Dashboard</h2>
                            <p class="text-purple-700">Full system access, user management, and system analytics.</p>
                        </div>
                        
                        <!-- System Stats -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-white rounded-lg shadow p-6">
                                <h3 class="text-lg font-semibold text-slate-900 mb-2">Total Users</h3>
                                <p id="total-users" class="text-3xl font-bold text-green-600">-</p>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <h3 class="text-lg font-semibold text-slate-900 mb-2">Active Sessions</h3>
                                <p id="active-sessions" class="text-3xl font-bold text-blue-600">-</p>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <h3 class="text-lg font-semibold text-slate-900 mb-2">Risk Alerts</h3>
                                <p id="risk-alerts" class="text-3xl font-bold text-red-600">-</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Check authentication status via API
                const response = await fetch('/api/auth/me', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const user = data.user;
                    
                    // Store user info in localStorage for consistency
                    localStorage.setItem('user', JSON.stringify(user));
                    
                    // Display user info
                    document.getElementById('user-name').textContent = user.first_name || user.email;
                    
                    // Show role-specific content
                    showRoleContent(user.role);
                    
                    // Load role-specific data
                    loadRoleData(user.role);
                } else {
                    // Not authenticated, redirect to login
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('Authentication check failed:', error);
                // On error, try to use localStorage as fallback
                const user = JSON.parse(localStorage.getItem('user') || 'null');
                if (!user) {
                    window.location.href = 'login.html';
                    return;
                }
                
                // Display user info
                document.getElementById('user-name').textContent = user.first_name || user.email;
                showRoleContent(user.role);
                loadRoleData(user.role);
            }
        });

        function showRoleContent(role) {
            // Hide all role content
            document.querySelectorAll('[id$="-content"]').forEach(el => el.classList.add('hidden'));
            
            // Show specific role content
            const roleElement = document.getElementById(role + '-content');
            if (roleElement) {
                roleElement.classList.remove('hidden');
            }
        }

        async function loadRoleData(role) {
            try {
                if (role === 'counselor' || role === 'faculty' || role === 'admin') {
                    await loadRiskData();
                }
                
                if (role === 'admin') {
                    await loadAdminStats();
                }
            } catch (error) {
                console.error('Error loading role data:', error);
            }
        }

        async function loadRiskData() {
            try {
                const response = await fetch('/api/dashboard/risk-data', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayRiskData(data.risk_data);
                }
            } catch (error) {
                console.error('Error loading risk data:', error);
            }
        }

        function displayRiskData(riskData) {
            const tbody = document.getElementById('risk-table-body');
            
            if (riskData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-slate-500">No risk data available</td></tr>';
                return;
            }
            
            tbody.innerHTML = riskData.map(student => {
                const riskLevel = student.dropout_risk > 0.7 ? 'High' : student.dropout_risk > 0.4 ? 'Medium' : 'Low';
                const riskColor = student.dropout_risk > 0.7 ? 'text-red-600' : student.dropout_risk > 0.4 ? 'text-yellow-600' : 'text-green-600';
                
                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">${student.student_id || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">${student.course || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${riskColor} font-medium">${riskLevel}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">${(student.dropout_risk * 100).toFixed(1)}%</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">
                            <button class="text-green-600 hover:text-green-900">View Details</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function loadAdminStats() {
            // Mock data for now - replace with actual API calls
            document.getElementById('total-users').textContent = '150';
            document.getElementById('active-sessions').textContent = '23';
            document.getElementById('risk-alerts').textContent = '7';
        }

        // Chat functionality
        document.getElementById('send-chat').addEventListener('click', async function() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addChatMessage('You', message, 'user');
            input.value = '';
            
            try {
                const response = await fetch('/api/chatbot/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ text: message })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    addChatMessage('AI Counselor', data.reply, 'ai');
                } else {
                    addChatMessage('System', 'Sorry, I encountered an error. Please try again.', 'system');
                }
            } catch (error) {
                addChatMessage('System', 'Network error. Please check your connection.', 'system');
            }
        });

        function addChatMessage(sender, message, type) {
            const container = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-2 p-2 rounded ${type === 'user' ? 'bg-blue-100 ml-8' : type === 'ai' ? 'bg-green-100 mr-8' : 'bg-gray-100'}`;
            messageDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // Logout functionality
        document.getElementById('logout-btn').addEventListener('click', async function() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                localStorage.removeItem('user');
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Logout error:', error);
                // Still redirect even if logout fails
                localStorage.removeItem('user');
                window.location.href = 'login.html';
            }
        });

        // Allow Enter key in chat input
        document.getElementById('chat-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('send-chat').click();
            }
        });
    </script>
</body>

</html>
